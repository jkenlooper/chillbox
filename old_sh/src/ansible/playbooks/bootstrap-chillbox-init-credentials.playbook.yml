---
- name: Bootstrap chillbox init credentials
  hosts: chillbox

  vars_files:
    - /run/tmp/ansible/terraform/vars.json

  tasks:
    # Check if the /etc/chillbox/init-date.txt file exists before attempting to
    # run this. The root user will be blocked after the initial run of this
    # playbook.
    - name: Register state of last init
      register: init_date_file
      ansible.builtin.stat:
        path: /etc/chillbox/init-date.txt

    # This is the only time that the root user will be able to ssh in. The
    # chillbox-init.sh script will update the /etc/ssh/sshd_config config to
    # block root user logins.
    - name: Decrypt the bootstrap file and execute
      when: not init_date_file.stat.exists
      remote_user: root
      ansible.builtin.shell:
        cmd: |
          openssl enc -aes-256-cbc -d -md sha512 -pbkdf2 -a -iter 100000 -salt \
            -pass pass:{{ bootstrap_chillbox_pass | quote }} \
            -in "/root/bootstrap-chillbox-init-credentials.sh.encrypted" \
            -out "/root/bootstrap-chillbox-init-credentials.sh"
          chmod u+x /root/bootstrap-chillbox-init-credentials.sh
          /root/bootstrap-chillbox-init-credentials.sh
        chdir: /root
        creates: /etc/chillbox/init-date.txt

    - name: Import update_sites_artifact role
      ansible.builtin.import_role:
        name: update_sites_artifact
