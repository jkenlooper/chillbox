---
- name: Bootstrap chillbox init credentials
  hosts: chillbox

  # TODO Check if the /etc/chillbox/init-date.txt file exists before attempting
  # to run this. The root user will be blocked after the initial run of this
  # playbook, so any later runs of this playbook will always fail as it is now.

  # This is the only time that the root user will be able to ssh in. The
  # chillbox-init.sh script will update the /etc/ssh/sshd_config config to block
  # root user logins.
  remote_user: root

  vars_files:
    - /run/tmp/ansible/terraform/vars.json
  tasks:
    - name: Decrypt the bootstrap file and execute
      ansible.builtin.shell:
        cmd: |
          openssl enc -aes-256-cbc -d -md sha512 -pbkdf2 -a -iter 100000 -salt \
            -pass pass:{{ bootstrap_chillbox_pass | quote }} \
            -in "/root/bootstrap-chillbox-init-credentials.sh.encrypted" \
            -out "/root/bootstrap-chillbox-init-credentials.sh"
          chmod u+x /root/bootstrap-chillbox-init-credentials.sh
          /root/bootstrap-chillbox-init-credentials.sh
        chdir: /root
        creates: /etc/chillbox/init-date.txt
