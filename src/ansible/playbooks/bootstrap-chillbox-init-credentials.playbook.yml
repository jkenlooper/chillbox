---

# TODO add ansibledev user and set up the doas config.
# The 'dev' user requires a password and should only be used when doing
# interactive ops.
# The 'ansibledev' user is only for doing maintenance type tasks like running an
# update on the installed packages with 'apk update' and rebooting the instance.
# The doas config can be configured to only allow a small subset of commands for
# the ansibledev user.

-
  name: Bootstrap chillbox init credentials
  hosts: chillbox
  remote_user: root
  vars_files:
    - /TODOvars/external_vars-for-bootstrap_chillbox_pass.yml
    - /run/tmp/ansible/terraform/vars.json

  # TODO Define the playbook tasks to do the initial run.
  tasks:

    -
      name: Decrypt the bootstrap file and execute
      ansible.builtin.shell:
        cmd: |
          openssl enc -aes-256-cbc -d -md sha512 -pbkdf2 -a -iter 100000 -salt \
            -pass pass:{{ bootstrap_chillbox_pass|quote }} \
            -in "/root/bootstrap-chillbox-init-credentials.sh.encrypted" \
            -out "/root/bootstrap-chillbox-init-credentials.sh"
          chmod u+x /root/bootstrap-chillbox-init-credentials.sh
          /root/bootstrap-chillbox-init-credentials.sh
        chdir: "/root"
        creates: "/etc/chillbox/init-date.txt"
